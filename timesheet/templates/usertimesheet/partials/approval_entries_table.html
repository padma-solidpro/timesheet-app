<div class="table-wrapper">
    <table id="approval-table" class="table table-sm align-middle approval-table">
        <thead class="table-light">
            <tr class="header-dark">
              <th><input type="checkbox" id="select-all"></th>
              <th>Date</th>
              <th>Employee</th>
              <th>Project</th>
              <th>Task</th>
              <th>Hours</th>
              <th>Status</th>
              <th>Review Comment</th>
            </tr>
            <tr class="header-light">
                <th></th>
                <th></th>
                <th>
                    <select class="form-select form-select-sm filter" data-column="2">
                        <option value="">All</option>
                    </select>
                </th>
                <th>
                    <select class="form-select form-select-sm filter" data-column="3">
                        <option value="">All</option>
                    </select>
                </th>
                <th></th>
                <th></th>
                <th>
                    <select class="form-select form-select-sm filter" data-column="6">
                        <option value="">All</option>
                    </select>
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% if approval_records %}
                {% for record in approval_records %}
                <tr>
                    <td><input type="checkbox" name="record_ids" value="{{ record.id }}"></td>
                    <td>{{ record.date }}</td>
                    <td>{{ record.resource.name }}</td>
                    <td>{{ record.project.name }}</td>
                    <td>{{ record.task }}</td>
                    <td>{{ record.hours }}</td>
                    <td>{{ record.status }}</td>
                    <td>
                        <input type="text" name="review_comment_{{ record.id }}"
                            class="form-control form-control-sm"
                            value="{{ record.review_comment|default:'' }}">
                    </td>
                </tr>
                {% empty %}
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="8" class="text-center">No timesheet entries found.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const hasData = {{ aprv_has_data|yesno:"true,false" }};
    if (!hasData) return;

    const tableElement = $('#approval-table');
    const filterCols = [2, 3, 6];  // Columns with dropdown filters

    const table = tableElement.DataTable({
      dom: 'lrtip',
      orderCellsTop: true,
      searching: true,
      lengthChange: false,
      fixedHeader: true,
      pageLength: 10,
      scrollY: '250px',
      scrollCollapse: true,
      order: [[1, 'desc']],
      columnDefs: [
        { targets: [0, 2, 3, 4, 5, 6, 7], orderable: false },
      ],
      initComplete: function () {
        const api = this.api();

        // Initialize filter dropdowns
        filterCols.forEach(function (colIdx) {
          const column = api.column(colIdx);
          const select = $(`select[data-column="${colIdx}"]`);

          select.empty().append('<option value="">All</option>');
          const uniqueValues = new Set();

          column.data().each(function (d) {
            const clean = $('<div>').html(d).text().trim();
            uniqueValues.add(clean);
          });

          Array.from(uniqueValues).sort().forEach(function (val) {
            select.append(`<option value="${val}">${val}</option>`);
          });

          select.on('change', function () {
            const val = $.fn.dataTable.util.escapeRegex($(this).val());
            column.search(val ? '^' + val + '$' : '', true, false).draw();
            updateAllDropdowns(api, filterCols);  // Interdependent behavior
          });
        });

        const urlParams = new URLSearchParams(window.location.search);
        let status = urlParams.get('status');

        console.log('URL Params:', window.location.search); // Log the entire query string
        console.log('Status from URL:', status); // Log the status value from the URL query param

        if (status) {
          // Clean the status by removing trailing slashes or any other unwanted characters
          status = status.replace(/\/$/, ''); // Remove trailing slash, if any

          // Capitalize the first letter of the status
          status = status.charAt(0).toUpperCase() + status.slice(1).toLowerCase();

          console.log('Cleaned Status (Capitalized):', status); // Log the cleaned and capitalized status value

          // Find the select element for column 6 (status)
          const select = $(`select[data-column="6"]`);

          // Check if the select element is found
          if (select.length) {
            console.log('Select element found:', select); // Log the select element
            select.val(status).trigger('change'); // Set the cleaned value and trigger change event
          } else {
            console.error('Select element not found!');
          }

          // Clean URL (remove query param)
          const cleanUrl = window.location.origin + window.location.pathname + window.location.hash;

          console.log('Clean URL:', cleanUrl); // Log the cleaned URL

          // Replace the URL in the browser's address bar
          window.history.replaceState({}, document.title, cleanUrl); 
        }


        // Update all dropdowns based on filtered rows (interdependent dropdown logic)
        function updateAllDropdowns(api, filterCols) {
          const filteredData = api.rows({ search: 'applied' }).data().toArray();

          filterCols.forEach(function (colIdx) {
            const select = $(`select[data-column="${colIdx}"]`);
            const selectedVal = select.val();
            const values = new Set();

            filteredData.forEach(function (row) {
              const val = $('<div>').html(row[colIdx]).text().trim();
              values.add(val);
            });

            select.empty().append('<option value="">All</option>');
            Array.from(values).sort().forEach(function (val) {
              select.append(`<option value="${val}">${val}</option>`);
            });

            if (selectedVal !== '') {
              select.val(selectedVal);
            }
          });
        }
      }
    });

    // "Select All" checkbox
    document.getElementById('select-all')?.addEventListener('change', function () {
      document.querySelectorAll('input[name="record_ids"]').forEach(cb => {
        cb.checked = this.checked;
      });
    });
    
});
</script>