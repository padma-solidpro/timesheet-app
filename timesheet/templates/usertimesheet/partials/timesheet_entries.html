<div id="timesheet-entries">
    <table id="timesheet-table" class="table table-bordered mt-4">
        <colgroup>
            <col style="width: 15%;">
            <col style="width: 10%;">
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 10%;">
            <col style="width: 10%;">
            <col style="width: 7.5%;">
            <col style="width: 2.5%;">
        </colgroup>
        <thead class="table-light">
            <tr class="header-dark">
                <th>Date</th>
                <th>Project</th>
                <th>Task</th>
                <th>Subtask</th>
                <th>Description</th>
                <th>Hours</th>
                <th>Review Comment</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
            <tr class="header-light">
                <th></th> <!-- Date: sortable only -->
                <th><select id="projectFilter" class="form-select form-select-sm filter"><option value="">All</option></select></th>
                <th><select id="taskFilter" class="form-select form-select-sm filter"><option value="">All</option></select></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th><select id="statusFilter" class="form-select form-select-sm filter"><option value="">All</option></select></th>
                <th></th> <!-- Action: no filter -->
            </tr>
        </thead>
        <tbody>
            {% if timesheet_entries %}
                {% for entry in timesheet_entries %}
                    <tr>
                        <td>{{ entry.date }}</td>
                        <td>{{ entry.project.name }}</td>
                        <td>{% if entry.task %}{{ entry.task.name }}{% else %}-{% endif %}</td>
                        <td>{% if entry.subtask %}{{ entry.subtask.name }}{% else %}-{% endif %}</td>
                        <td>{{ entry.task_description }}</td>
                        <td>{{ entry.hours }}</td>
                        <td>{{ entry.review_comment }}</td>
                        <td>
                            {% if entry.status == 'Approved' %}
                                <span class="badge bg-success">Approved</span>
                            {% elif entry.status == 'Pending' %}
                                <span class="badge bg-warning text-dark">Pending</span>
                            {% else %}
                                <span class="badge bg-danger">Rejected</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.status != "Approved" %}
                                <button class="btn btn-sm btn-primary"
                                        hx-get="{% url 'edit_timesheet' entry.id %}"
                                        hx-target="#modal-body"
                                        hx-trigger="click"
                                        _="on htmx:afterSwap wait 10ms then call bootstrap.Modal.getOrCreateInstance(#modal) then call show()"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modal">
                                    Edit
                                </button>
                            {% else %}
                                <span class="text-muted">Locked</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="9" class="text-center">No timesheet entries found.</td></tr>
            {% endif %}
        </tbody>
    </table>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const hasData = {{ self_has_data|yesno:"true,false" }};
        console.log("Has data:", hasData);
        if (!hasData) return;

        let initialized = false;

        function extractUniqueValuesFromTable(columnIndex) {
            const values = new Set();
            $('#timesheet-table tbody tr').each(function () {
                const cell = $(this).find('td').eq(columnIndex);
                const value = cell.text().trim();
                if (value && value !== '-') {
                    values.add(value);
                }
            });
            const sortedValues = Array.from(values).sort();
            console.log(`Unique values from column ${columnIndex}:`, sortedValues);
            return sortedValues;
        }

        function buildProjectTaskMap() {
            const map = {};
            $('#timesheet-table tbody tr').each(function () {
                const project = $(this).find('td').eq(1).text().trim();
                const task = $(this).find('td').eq(2).text().trim();
                if (!map[project]) map[project] = new Set();
                if (task && task !== '-') map[project].add(task);
            });
            console.log("Built project-task map:", map);
            return map;
        }

        function initializeTimesheetTable() {
        if (initialized) {
            console.log("Table already initialized");
            return;
        }

        console.log("Initializing DataTable...");

        const table = $('#timesheet-table').DataTable({
            dom: 'lrtip',
            orderCellsTop: true,
            searching: true,
            lengthChange: false,
            fixedHeader: true,
            pageLength: 10,
            order: [[0, 'desc']],
            columnDefs: [
                { targets: [1, 2], orderable: false },
                { targets: 0, orderable: true },
                { targets: '_all', orderable: false }
            ]
        });

        const projectFilter = $('#projectFilter');
        const taskFilter = $('#taskFilter');
        const statusFilter = $('#statusFilter');

        const projectTasksMap = buildProjectTaskMap();

        // Populate project dropdown
        projectFilter.empty().append('<option value="">All</option>');
        Object.keys(projectTasksMap).sort().forEach(project => {
            projectFilter.append(`<option value="${project}">${project}</option>`);
        });
        console.log("Project filter options populated.");

        // Populate all tasks
        const allTasks = new Set();
        Object.values(projectTasksMap).forEach(set => {
            set.forEach(task => allTasks.add(task));
        });
        taskFilter.empty().append('<option value="">All</option>');
        Array.from(allTasks).sort().forEach(task => {
            taskFilter.append(`<option value="${task}">${task}</option>`);
        });
        console.log("Task filter options populated.");

        // Populate status filter
        const allStatus = new Set();
        table.rows().every(function () {
            const cellText = $(this.node()).find('td').eq(7).text().trim(); // Get text from status badge
            if (cellText) allStatus.add(cellText);
        });

        statusFilter.empty().append('<option value="">All</option>');
        Array.from(allStatus).sort().forEach(status => {
            statusFilter.append(`<option value="${status}">${status}</option>`);
        });
        console.log("Status filter options populated.");

        // Project filter change
        projectFilter.on('change', function () {
            const selectedProject = $(this).val();
            console.log("Project selected:", selectedProject);
            table.column(1).search(selectedProject ? '^' + selectedProject + '$' : '', true, false).draw();

            const relatedTasks = selectedProject ? projectTasksMap[selectedProject] || new Set() : allTasks;
            taskFilter.empty().append('<option value="">All</option>');
            Array.from(relatedTasks).sort().forEach(task => {
                taskFilter.append(`<option value="${task}">${task}</option>`);
            });

            // Reset task filter
            taskFilter.val('');
            table.column(2).search('').draw();
        });

        // Task filter change
        taskFilter.on('change', function () {
            const selectedTask = $(this).val();
            console.log("Task selected:", selectedTask);
            table.column(2).search(selectedTask ? '^' + selectedTask + '$' : '', true, false).draw();
        });

        // Status filter change
        statusFilter.on('change', function () {
            const selectedStatus = $(this).val();
            console.log("Status selected:", selectedStatus);
            table.column(7).search(selectedStatus ? '^' + selectedStatus + '$' : '', true, false).draw();
        });

        initialized = true;
        console.log("Table initialization complete.");
    }


        // Tab activation logic
        $('a[data-bs-toggle="tab"], button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            const target = $(e.target).attr('href') || $(e.target).data('bsTarget');
            console.log("Tab shown:", target);
            if ($(target).find('#timesheet-table').length && !initialized) {
                console.log("Timesheet table is now visible. Initializing...");
                requestAnimationFrame(initializeTimesheetTable);
            }
        });

        // Immediate init if already visible
        if ($('#timesheet-table').is(':visible') && !initialized) {
            console.log("Timesheet table is already visible. Initializing...");
            requestAnimationFrame(initializeTimesheetTable);
        } else {
            console.log("Timesheet table not visible on load.");
        }
    });
</script>
