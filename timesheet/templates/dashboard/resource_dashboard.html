{% extends 'base.html' %}
{% load static %}
 
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Dashboard</h2>
 
  <form method="get" class="row row-cols-auto g-3 align-items-center mb-4">
    <div class="col">
      <input type="date" id="startDate" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
    </div>
    <div class="col">
      <input type="date" id="endDate" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
    </div>
    <div class="col align-self-end">
      <button type="submit" class="btn btn-primary">Apply Filter</button>
    </div>
  </form>
 
  <!-- Reduced Size Summary Cards -->
  <div class="row text-center mb-3">
    <div class="col-sm-4 col-md-2">
      <div class="card p-1 shadow-sm small-card ">
        <h6 class="mb-1" style="font-size: 0.9rem;">Total Projects</h6>
        <h3>{{ total_assigned_projects }}</h3>
      </div>
    </div>
    <div class="col-sm-4 col-md-2">
      <div class="card p-1 shadow-sm small-card ">
        <h6 class="mb-1" style="font-size: 0.9rem;">Total Hours</h6>
        <h3>{{ total_hours }}</h3>
      </div>
    </div>
    <div class="col-sm-4 col-md-2">
      <div class="card p-1 shadow-sm small-card">
        <h6 class="mb-1">Utilization%</h6>
        <h3>{{ utilization }}</h3>
      </div>
    </div>
  </div>
 
  <!-- Row 1: Logged Hours + Worked Hours Summary -->
  <div class="row mb-4">
    <div class="col-md-6" id="loggedHoursSection">
      <div class="card chart-container h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="card-title">Logged Hours</h6>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary active" onclick="switchLoggedChart('project')">Project</button>
            <button class="btn btn-outline-primary" onclick="switchLoggedChart('task')">Task</button>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="chart-wrapper">
            <canvas id="loggedChart"></canvas>
          </div>
        </div>
      </div>
    </div>
 
    <div class="col-md-6" id="workedHoursSummarySection">
      <div class="card chart-container h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="card-title">Worked Hours Summary</h6>
          <div class="btn-group btn-group-sm">
            <button id="btn-week" class="btn btn-outline-primary active" onclick="switchView('week')">Weekly</button>
            <button id="btn-month" class="btn btn-outline-primary" onclick="switchView('month')">Monthly</button>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="chart-wrapper">
            <canvas id="timeSummaryChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
 
  <!-- Row 2: Billable vs Non-Billable + Allotted vs Logged -->
  <div class="row mb-4">
    <div class="col-md-4" id="billableHoursSection">
      <div class="card chart-container h-100">
        <div class="card-header">
          <h6 class="card-title">Billable vs Non-Billable Hours</h6>
        </div>
        <div class="card-body p-2">
          <div class="chart-wrapper">
            <canvas id="billableChart"></canvas>
          </div>
        </div>
      </div>
    </div>
 
    <div class="col-md-8" id="allottedVsLoggedSection">
      <div class="card chart-container h-100">
        <div class="card-header">
          <h6 class="card-title">Allotted vs Logged Hours (per Task)</h6>
        </div>
        <div class="card-body p-2">
          <div class="chart-wrapper">
            <canvas id="allottedChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let projectChart, timeSummaryChart, allottedChart, loggedChart;
let currentView = "week";

// These need to be accessible globally
const weeklyLabels = {{ weekly_labels|safe }};
const weeklyData = {{ weekly_values|safe }};
const monthlyLabels = {{ monthly_labels|safe }};
const monthlyData = {{ monthly_values|safe }};

// âœ… Move this OUTSIDE the DOMContentLoaded block
const loggedChartData = {
  project: {
    labels: {{ project_hours_labels|safe }},
    data: {{ project_hours_values|safe }}
  },
  task: {
    labels: {{ task_hours_labels|safe }},
    data: {{ task_hours_values|safe }}
  }
};

document.addEventListener("DOMContentLoaded", () => {
  // Logged Hours Chart (Initial: Project)
  loggedChart = new Chart(document.getElementById("loggedChart"), {
    type: "bar",
    data: {
      labels: loggedChartData.project.labels,
      datasets: [{
        label: "Hours",
        data: loggedChartData.project.data,
        backgroundColor: "#4e73df"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } }
    }
  });

  // Donut Chart: Billable vs Non-Billable
  new Chart(document.getElementById("billableChart"), {
    type: "doughnut",
    data: {
      labels: ["Billable", "Non-Billable"],
      datasets: [{
        data: [{{ billable_hours }}, {{ non_billable_hours }}],
        backgroundColor: ["#1cc88a", "#e74a3b"]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: "70%"
    }
  });

  // Time Summary Chart
  timeSummaryChart = new Chart(document.getElementById("timeSummaryChart"), {
    type: "line",
    data: {
      labels: weeklyLabels,
      datasets: [{
        label: "Hours Worked",
        data: weeklyData,
        borderColor: "#36b9cc",
        backgroundColor: "#36b9cc",
        fill: false,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });

  // Allotted vs Logged Chart
  allottedChart = new Chart(document.getElementById("allottedChart"), {
    type: "bar",
    data: {
      labels: [{% for row in task_comparison %}"{{ row.task }}",{% endfor %}],
      datasets: [
        {
          label: "Allotted",
          data: [{% for row in task_comparison %}{{ row.allotted|floatformat:0 }},{% endfor %}],
          backgroundColor: "#4e73df"
        },
        {
          label: "Logged",
          data: [{% for row in task_comparison %}{{ row.logged|floatformat:0 }},{% endfor %}],
          backgroundColor: "#e74a3b"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
});

// Chart Switch Buttons
function switchView(view) {
  currentView = view;
  document.getElementById("btn-week").classList.remove("active");
  document.getElementById("btn-month").classList.remove("active");
  document.getElementById("btn-" + view).classList.add("active");

  if (view === "week") {
    updateTimeSummary(weeklyLabels, weeklyData);
  } else {
    updateTimeSummary(monthlyLabels, monthlyData);
  }
}

function switchLoggedChart(view) {
  if (loggedChart && loggedChartData[view]) {
    loggedChart.data.labels = loggedChartData[view].labels;
    loggedChart.data.datasets[0].data = loggedChartData[view].data;
    loggedChart.update();

    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`button[onclick="switchLoggedChart('${view}')"]`).classList.add('active');
  }
}

function updateTimeSummary(labels, data) {
  timeSummaryChart.data.labels = labels;
  timeSummaryChart.data.datasets[0].data = data;
  timeSummaryChart.update();
}
</script>

{% endblock %}
